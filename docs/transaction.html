<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CryptoCynic - Transaction Tracker</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    /* Internal CSS example */
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #222; color: #fff; }
    tr:hover { background-color: #f5f5f5; }
    form { margin-top: 20px; }
    input[type="text"] { padding: 8px; width: 60%; margin-right: 10px; }
    button { padding: 8px 12px; background-color: #222; color: #fff; border: none; cursor: pointer; }
    button:hover { background-color: #555; }
  </style>
</head>
<body>

  <header class="fixed-header">
    <div class="logo">CryptoCynic</div>
    <nav>
      <a href="index.html">Home</a>
      <a href="transaction.html">View Transactions</a>
      <a href="about.html">About</a>
    </nav>
  </header>

  <main>
    <h1>Transaction Tracker</h1>
    <p>Enter a Bitcoin transaction hash to see its status in the mempool.</p>

    <form id="tx-form">
      <label for="txid">Transaction ID:</label>
      <input type="text" id="txid" name="txid" placeholder="Enter Transaction Hash" required>
      <button type="submit">Track Transaction</button>
    </form>

    <ul id="mempool-list"></ul>

    <!-- Dynamic Table -->
    <table>
      <tr><th>Feature</th><th>Value</th></tr>
      <tr><td>Status</td><td>--</td></tr>
      <tr><td>Transaction Fee</td><td>--</td></tr>
      <tr><td>Transaction Size</td><td>--</td></tr>
      <tr><td>Time in Mempool</td><td>--</td></tr>
      <tr><td>Approx. Mempool Rank</td><td>--</td></tr>
      <tr><td>Estimated Confirmation</td><td>--</td></tr>
      <tr><td>Block Inclusion</td><td>--</td></tr>
      <tr><td>Number of Confirmations</td><td>--</td></tr>
    </table>

  </main>

  <footer class="fixed-footer">
    <p>&copy; 2026 CryptoCynic | <a href="about.html">About</a></p>
  </footer>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('tx-form');
      const txTable = document.querySelector('table');
      const mempoolList = document.getElementById('mempool-list');

      if (!form || !txTable || !mempoolList) return;

      // -----------------------------
      // Function: Load transaction
      // -----------------------------
      async function loadTransaction(txid) {
          try {
              const res = await fetch(`http://127.0.0.1:8000/mempool/${txid}`);
              const data = await res.json();

              if (data.error) {
                  alert("Transaction not found in mempool.");
                  return;
              }

              const txData = {
                  status: "Unconfirmed",
                  fee: data.fee_sats + " sats",
                  size: data.vsize + " vB",
                  timeInMempool: data.time_in_mempool + " mins",
                  mempoolRank: data.feerate + " sats/vB",
                  estimatedConfirmation: "Calculating...",
                  blockInclusion: "Pending",
                  confirmations: "0"
              };

              const tableMap = [
                  'status',
                  'fee',
                  'size',
                  'timeInMempool',
                  'mempoolRank',
                  'estimatedConfirmation',
                  'blockInclusion',
                  'confirmations'
              ];

              tableMap.forEach((field, i) => {
                  txTable.rows[i+1].cells[1].innerText = txData[field];
              });

          } catch (err) {
              console.error(err);
              alert("Failed to fetch transaction.");
          }
      }

      // -----------------------------
      // Function: Refresh mempool list
      // -----------------------------
      async function refreshMempool(limit = 25) {
          try {
              const res = await fetch(`http://127.0.0.1:8000/mempool?limit=${limit}`);
              const data = await res.json();

              mempoolList.innerHTML = "";

              data.txids.forEach(txid => {
                  const li = document.createElement("li");
                  li.innerHTML = `<a href="#" data-txid="${txid}">${txid.slice(0,12)}...</a>`;
                  mempoolList.appendChild(li);
              });
          } catch (err) {
              console.error("Failed to fetch mempool:", err);
          }
      }

      // -----------------------------
      // Handle form submission
      // -----------------------------
      form.addEventListener('submit', (e) => {
          e.preventDefault();
          const txid = document.getElementById('txid').value.trim();
          if (!txid) return alert("Please enter a transaction ID.");

          // Clear old table values
          for (let i = 1; i < txTable.rows.length; i++) {
              txTable.rows[i].cells[1].innerText = '--';
          }

          loadTransaction(txid);
      });

      // -----------------------------
      // Handle clicks on mempool list
      // -----------------------------
      mempoolList.addEventListener('click', (e) => {
          if (e.target.dataset.txid) {
              e.preventDefault();
              const txid = e.target.dataset.txid;
              document.getElementById('txid').value = txid;

              // Clear old table values
              for (let i = 1; i < txTable.rows.length; i++) {
                  txTable.rows[i].cells[1].innerText = '--';
              }

              loadTransaction(txid);
          }
      });

      // -----------------------------
      // Initial mempool load + auto-refresh
      // -----------------------------
      refreshMempool();
      setInterval(refreshMempool, 10000); // refresh every 10 seconds
  });
  </script>

</body>
</html>
